#!/bin/sh
# Copyright 2016, Jeffrey E. Bedard

CFG=config.mk
DEBUG=false

rm -f "$CFG"

while getopts 'd' opt
do
	case $opt in
	d)
		DEBUG=true
		;;
	?)
		echo -e '-d\tenable debugging'
		echo -e '-*\thelp'
		;;
	esac
done 

ARCH=`uname | tr 'a-z' 'A-Z'`

echo "Configuring for $ARCH"

if $DEBUG; then
	echo "CFLAGS=" >> $CFG
else
	echo "CFLAGS=$CFLAGS" >> $CFG
fi

echo CFLAGS+="-D${ARCH}" >> $CFG

case $ARCH in
	OPENBSD)
		CC=clang
		echo NOTE:  OpenBSD requires llvm
		cat >> $CFG <<- EOF
		CC=clang
		PREFIX=/usr/local
		LIBS+=-L/usr/X11R6/lib
		LIBS+=-L/usr/local/lib
		CFLAGS+=-D_BSD_SOURCE
		CFLAGS+=-I/usr/X11R6/include 
		CFLAGS+=-I/usr/local/include 
		EOF
		;;
	LINUX) 
		cat >> $CFG <<- EOF
		CFLAGS+=-D_GNU_SOURCE
		EOF
		;;
	NETBSD)
		cat >> $CFG <<- EOF
		CFLAGS+=-D_NETBSD_SOURCE -D_BSD_SOURCE
		CFLAGS+=-Wno-missing-field-initializers
		CFLAGS+=-I/usr/pkg/include
		CFLAGS+=-I/usr/X11R7/include 
		CFLAGS+=-I/usr/X11R6/include
		LIBS+=-L/usr/pkg/lib -Wl,-R/usr/pkg/lib
		LIBS+=-L/usr/X11R7/lib -Wl,-R/usr/X11R7/lib
		LIBS+=-L/usr/X11R6/lib -Wl,-R/usr/X11R6/lib
		PREFIX=/usr/local
		EOF
		;;
	FREEBSD)
		cat >> $CFG <<- EOF
		CFLAGS+=-DFREEBSD -D_BSD_SOURCE -D__BSD_VISIBLE
		CFLAGS+=-I/usr/local/include
		LIBS+=-L/usr/local/lib
		PREFIX=/usr/local
		EOF
		;;
esac

echo -n 'Checking for libutempter... '
if [ -f /usr/lib/libutempter.so ]; then
	echo found
	cat >> $CFG <<- EOF
	CFLAGS+=-DUSE_UTEMPTER
	LIBS+=-lutempter
	EOF
else
	echo not found
fi

echo -n 'Checking for asm-generic/ioctls.h... '
if [ -f /usr/include/asm-generic/ioctls.h ]; then
	echo found
	echo 'CFLAGS+=-DHAVE_ASM_GENERIC_IOCTLS_H' >> $CFG
else
	echo not found
fi

search() # 1: cmd 2: var
{
	echo -n "Checking for $1... "
	local CMD=`command -v $1`
	if [ "$CMD" ]; then
		echo $CMD
		echo "$2=$CMD" >> $CFG
		export $2=$1
		return 1
	fi
	echo not found
	return 0
}

if [ ! "$CC" ]; then
	search clang CC \
		&& search gcc CC \
		&& search icc CC \
		&& search cc CC \
		&& (echo 'FATAL: no compiler found.  Please set CC' \
			exit 1);
fi

if $DEBUG; then
	echo 'Enabling debug code...'
	if [ "$CC" = "clang" ]; then
		echo 'include debug_clang.mk' >> $CFG
	elif [ "$CC" = "gcc" ]; then
		echo 'include debug_gcc.mk' >> $CFG
	else
		echo 'include debug.mk' >> $CFG
	fi
fi
